// –ü—Ä–æ—Å—Ç–æ–π Telegram –±–æ—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Mini App
// –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ Vercel

const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const MINI_APP_URL = process.env.MINI_APP_URL;

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(200).json({ status: 'Bot is running' });
  }

  try {
    const { message } = req.body;
    
    if (!message) {
      return res.status(200).json({ ok: true });
    }

    const chatId = message.chat.id;
    const text = message.text;

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
    if (text === '/start') {
      await sendMessage(chatId, 
        'üëã –ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç.\n\n' +
        'üìä –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ –∏ –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑.',
        {
          reply_markup: {
            inline_keyboard: [[
              {
                text: 'üìà –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫',
                web_app: { url: MINI_APP_URL }
              }
            ]]
          }
        }
      );
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /help
    else if (text === '/help') {
      await sendMessage(chatId,
        'üìö *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞:*\n\n' +
        '1Ô∏è‚É£ –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É "–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫"\n' +
        '2Ô∏è‚É£ –ó–∞–≥—Ä—É–∑–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç –≥—Ä–∞—Ñ–∏–∫–∞\n' +
        '3Ô∏è‚É£ –ü–æ–ª—É—á–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑\n\n' +
        'üí° *–°–æ–≤–µ—Ç—ã:*\n' +
        '‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π –≥—Ä–∞—Ñ–∏–∫–∏ —Å —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–º –æ—Ç 15 –º–∏–Ω—É—Ç\n' +
        '‚Ä¢ –£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤–∏–¥–Ω—ã —Ü–µ–Ω—ã –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã\n' +
        '‚Ä¢ –õ—É—á—à–µ —Ä–∞–±–æ—Ç–∞—é—Ç —á–∏—Å—Ç—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏\n\n' +
        '‚ö†Ô∏è –ü–æ–º–Ω–∏: —ç—Ç–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∞ –Ω–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–æ–≤–µ—Ç!',
        { parse_mode: 'Markdown' }
      );
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ñ–æ—Ç–æ –Ω–∞–ø—Ä—è–º—É—é)
    else if (message.photo) {
      await sendMessage(chatId,
        'üì∏ –ß—Ç–æ–±—ã –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫, –∏—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.',
        {
          reply_markup: {
            inline_keyboard: [[
              {
                text: 'üìà –û—Ç–∫—Ä—ã—Ç—å –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä',
                web_app: { url: MINI_APP_URL }
              }
            ]]
          }
        }
      );
    }
    
    // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞
    else {
      await sendMessage(chatId,
        '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞.\n\n' +
        '–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n' +
        '/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É\n' +
        '/help - –ü–æ–º–æ—â—å'
      );
    }

    return res.status(200).json({ ok: true });
    
  } catch (error) {
    console.error('Error:', error);
    return res.status(200).json({ ok: true });
  }
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage(chatId, text, options = {}) {
  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
  
  await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      chat_id: chatId,
      text: text,
      ...options
    })
  });
}
