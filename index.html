<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ê–Ω–∞–ª–∏–∑ –ì—Ä–∞—Ñ–∏–∫–æ–≤</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* --- –ó–¥–µ—Å—å –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–µ—Å—å CSS –∏–∑ –≤–∞—à–µ–≥–æ –∫–æ–¥–∞ --- */
</style>
</head>
<body>
<div class="container">
    <h1>üìä –ê–Ω–∞–ª–∏–∑ –ì—Ä–∞—Ñ–∏–∫–æ–≤</h1>
    <p class="subtitle">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>
    
    <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üì∏</div>
        <p><strong>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</strong></p>
        <input type="file" id="fileInput" accept="image/*">
    </div>
    
    <div class="preview-container" id="previewContainer">
        <img class="preview-image" id="previewImage" alt="Preview">
        <button class="analyze-btn" id="analyzeBtn">üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≥—Ä–∞—Ñ–∏–∫...</p>
    </div>
    
    <div class="results" id="results">
        <div class="result-section">
            <div class="result-title">üìà –¢—Ä–µ–Ω–¥</div>
            <div class="result-content" id="trendResult"></div>
        </div>
        <div class="result-section">
            <div class="result-title">üéØ –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞</div>
            <div class="result-content" id="entryPoints"></div>
        </div>
        <div class="result-section">
            <div class="result-title">üõ°Ô∏è Stop Loss</div>
            <div class="result-content" id="stopLoss"></div>
        </div>
        <div class="result-section">
            <div class="result-title">üí∞ Take Profit</div>
            <div class="result-content" id="takeProfit"></div>
        </div>
        <div class="result-section">
            <div class="result-title">‚ö†Ô∏è –†–∏—Å–∫–∏</div>
            <div class="result-content" id="risks"></div>
        </div>
    </div>
</div>

<script>
let tg = window.Telegram.WebApp;
tg.expand();
tg.enableClosingConfirmation();

const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const previewContainer = document.getElementById('previewContainer');
const previewImage = document.getElementById('previewImage');
const analyzeBtn = document.getElementById('analyzeBtn');
const loading = document.getElementById('loading');
const results = document.getElementById('results');

let selectedFile = null;

uploadArea.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', (e) => {
    e.preventDefault(); 
    uploadArea.classList.remove('dragover'); 
    handleFile(e.dataTransfer.files[0]);
});

function handleFile(file) {
    if (!file || !file.type.startsWith('image/')) {
        tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
        return;
    }
    selectedFile = file;
    const reader = new FileReader();
    reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewContainer.style.display = 'block';
        uploadArea.style.display = 'none';
        results.style.display = 'none';
    };
    reader.readAsDataURL(file);
}

analyzeBtn.addEventListener('click', async () => {
    if (!selectedFile) return;
    
    analyzeBtn.disabled = true;
    loading.style.display = 'block';
    results.style.display = 'none';
    
    const base64 = await fileToBase64(selectedFile);

    try {
        const analysis = await analyzeChart(base64);
        displayResults(analysis);
        loading.style.display = 'none';
        results.style.display = 'block';
        tg.showAlert('‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!');
    } catch (error) {
        loading.style.display = 'none';
        tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ' + error.message);
    } finally {
        analyzeBtn.disabled = false;
    }
});

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });
}

// --- –ó–∞–ø—Ä–æ—Å –∫ ChatGPT API —Å –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª—å—é ---
async function analyzeChart(base64Image) {
    const OPENAI_API_KEY = '<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>'; // –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –∫–ª—é—á OpenAI –∑–¥–µ—Å—å
    
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${OPENAI_API_KEY}`
        },
        body: JSON.stringify({
            model: 'gpt-4o-mini', 
            messages: [
                {
                    role: 'user',
                    content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç –≥—Ä–∞—Ñ–∏–∫ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã –∫–∞–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä –∏ –≤–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –°–¢–†–û–ì–û –≤ JSON.`,
                    input_image: [
                        { type: 'base64', data: base64Image, mime_type: 'image/jpeg' }
                    ]
                }
            ],
            max_tokens: 2000
        })
    });

    if (!response.ok) {
        const errText = await response.text();
        throw new Error(errText || '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞');
    }

    const data = await response.json();
    const text = data.choices[0].message.content;

    try {
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        return jsonMatch ? JSON.parse(jsonMatch[0]) : JSON.parse(text);
    } catch {
        return { trend: 'unknown', trendDescription: text, entryPoints:{}, stopLoss:{}, takeProfit:[], risks:'–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON' };
    }
}

function displayResults(analysis) {
    const trendBadge = analysis.trend === 'bullish' ? 'badge-bullish' : 
                       analysis.trend === 'bearish' ? 'badge-bearish' : 'badge-neutral';
    document.getElementById('trendResult').innerHTML = `<span class="badge ${trendBadge}">${analysis.trendDescription}</span>`;
    document.getElementById('entryPoints').innerHTML = `<strong>Long:</strong> ${analysis.entryPoints.long?.price || 'N/A'}<br>
                                                        <strong>Short:</strong> ${analysis.entryPoints.short?.price || 'N/A'}`;
    document.getElementById('stopLoss').innerHTML = `Long SL: ${analysis.stopLoss.long || 'N/A'}<br>
                                                     Short SL: ${analysis.stopLoss.short || 'N/A'}`;
    document.getElementById('takeProfit').innerHTML = analysis.takeProfit.join('<br>');
    document.getElementById('risks').textContent = analysis.risks;
}

tg.ready();
</script>
</body>
</html>
